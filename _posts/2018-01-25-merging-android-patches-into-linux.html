---
layout: post
title: Merging Android patches into Linux kernel
date: '2018-01-25T09:06:00.003+05:30'
author: Gautam Bhat
tags: 
modified_time: '2018-03-09T14:36:15.086+05:30'
blogger_id: tag:blogger.com,1999:blog-2655423030126048565.post-2407274598355863193
blogger_orig_url: https://thesoulofamachine.blogspot.com/2018/01/merging-android-patches-into-linux.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">I am trying to port Android to the Beaglebone black and do a basic kernel boot. This is the step by step log of my journey.</span></span><br /><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;"><br /></span></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">First I clone the mainline kernel and boot up my BBB. I use the omap2plus_defconfig and am335x-boneblack.dtb file to boot-up the BBB. This will act as my <b>reference kernel</b>.</span></span><br /><span style="font-size: small;"><br /></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">Next I clone the<b> Android kernel</b> as follows:</span></span><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">git clone https://android.googlesource.com/kernel/common<br /></pre></div><span style="font-size: x-small;"><span style="font-family: &quot;verdana&quot; , sans-serif;"><br /></span></span><br /><div style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">Next we find match the kernel version numbers. So in my <b>reference kernel</b> I check the tags of the kernel version number. My partial output is as follows:</span></span></div><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18</pre></td><td><pre style="line-height: 125%; margin: 0;">v4.13<br />v4.13-rc1<br />v4.13-rc2<br />v4.13-rc3<br />v4.13-rc4<br />v4.13-rc5<br />v4.13-rc6<br />v4.13-rc7<br />v4.14<br />v4.14-rc1<br />v4.14-rc2<br />v4.14-rc3<br />v4.14-rc4<br />v4.14-rc5<br />v4.14-rc6<br />v4.14-rc7<br />v4.14-rc8<br />v4.15-rc1<br /></pre></td></tr></tbody></table></div><br /><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">Next we check the branches of the <b>Android kernel</b>. We do a git branch -a. The partial output is as follows:</span></span><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12</pre></td><td><pre style="line-height: 125%; margin: 0;">  remotes/origin/android-3.18-n-release<br />  remotes/origin/android-3.18-o-mr1<br />  remotes/origin/android-3.18-o-release<br />  remotes/origin/android-4.14<br />  remotes/origin/android-4.4<br />  remotes/origin/android-4.4-eas-test<br />  remotes/origin/android-4.4-llvm<br />  remotes/origin/android-4.4-n<br />  remotes/origin/android-4.4-n-release<br />  remotes/origin/android-4.4-o<br />  remotes/origin/android-4.4-o-mr1<br />  remotes/origin/android-4.4-o-release<br /></pre></td></tr></tbody></table></div><span style="font-size: x-small;"><span style="font-family: &quot;verdana&quot; , sans-serif;"><br /></span></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">I have decided to use the 4.14 kernel. So I decide to checkout the 4.14 in both the <b>Reference kernel</b> and <b>Android kernel</b>.</span></span><br /><span style="font-size: small;"><br /></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">In my Android tree I do a:</span></span><br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;">1</pre></td><td><pre style="line-height: 125%; margin: 0;">git checkout remotes/origin/android-4.14 -b android_4.14_linux_merge<br /></pre></td></tr></tbody></table></div><span style="font-size: x-small;"><span style="font-family: &quot;verdana&quot; , sans-serif;"><br /></span></span><span style="font-size: x-small;"><span style="font-family: &quot;verdana&quot; , sans-serif;"></span></span><br /><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">Git log generally shows:</span></span><br /><br /><span style="font-size: small;"><i><span style="font-size: xx-small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">"Merge 4.14.14 into android-4.14"</span></span></i></span><br /><span style="font-size: small;"><br /></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">In the Linux kernel we do the same:</span></span><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;">1</pre></td><td><pre style="line-height: 125%; margin: 0;">git checkout v4.14 -b linux_4.14_android_merge<br /></pre></td></tr></tbody></table></div><span style="font-size: small;"><br /></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">Git log generally shows:</span></span><br /><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;"><i>"Linux 4.14"</i></span></span><br /><span style="font-size: small;"><br /></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">Next we start the merging process.</span></span><br /><span style="font-size: small;"><br /></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">We go to the Android kernel directory and check for the point where Linux 4.14 LTS was used to add the Android patches on top. For this we do the following:</span></span><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">git log --pretty=oneline --grep="Linux 4.14"<br /></pre></div><br /><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">&nbsp;We get the following output:</span></span><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23<br />24<br />25<br />26<br />27<br />28<br />29<br />30<br />31<br />32<br />33<br />34<br />35<br />36<br />37<br />38<br />39<br />40</pre></td><td><pre style="line-height: 125%; margin: 0;">9b68347c3554e886487ea5587cde21926d950f15 (HEAD -&gt; android_4.14_linux_merge, origin/android-4.14) Merge 4.14.14 into android-4.14<br />9c0bf9847171edd597a13adf3ddc879e96d947cd (origin/upstream-linux-4.14.y) Linux 4.14.14<br />918914133ea13a07ec7967b25f0992c1f8928411 Merge 4.14.13 into android-4.14<br />b8447222eb207d5a5ec20a0f357065963dabdcd0 Linux 4.14.13<br />81e7d4589439a5b5dd07b7ecb7b02dbea7f6f795 Merge 4.14.12 into android-4.14<br />8d577afdee3540808302d9dc7a0a7be96c91178f Linux 4.14.12<br />51caa5cc8092b11fd91a7ffc12428bff47ddf518 Merge 4.14.11 into android-4.14<br />7af3494ec5325187effc30bef12ae72318cb2108 Merge 4.14.10 into android-4.14<br />0cf36be1cdf63598e98f094d4fb5e65dab164d14 Merge 4.14.9 into android-4.14<br />7237d3f322a7b005f751eb0e8da6e766ae6d9dca Merge 4.14.8 into android-4.14<br />5adbbb16a574d794c3b1573b8bcc0f51b3035985 Merge 4.14.7 into android-4.14<br />20f3b53781e9102b365f66cfa883aee95e932bb3 Merge 4.14.6 into android-4.14<br />0730eb4486b992c6a6193b48d54ffb463e4cec73 Merge 4.14.5 into android-4.14<br />0730eb4486b992c6a6193b48d54ffb463e4cec73 Merge 4.14.5 into android-4.14<br />c5c36272cda5e0fddadd1cff144d436514e509f2 Merge 4.14.4 into android-4.14<br />50cb0d5ca6df48129265cf7bde4e738fe509050c Merge 4.14.3 into android-4.14<br />fbbc906cb44d660eee3ce8c6c30eeccc79ecb144 Merge 4.14.2 into android-4.14<br />dc6bfa18652919ae193a3bcd05c6fcc49327bdd0 Merge 4.14.1 into android-4.14<br />0d59679df5b53755c00ea0292df696f97bfc950d Linux 4.14.11<br />b8ce8232fcc37fe7a97db79ea0a5f32098c25e72 Linux 4.14.10<br />dad5c1402c570cd07a80113784bc20a7f930c8ae Linux 4.14.9<br />7b3775017f4e6b87dfd2c7f63d1eaf057948f31d Linux 4.14.8<br />3afae8437c3cbc22966762e80e81818f5a90eb06 Linux 4.14.7<br />5fd159e1ee6a87a72626139813034f24f047d0e6 Linux 4.14.6<br />64138f0adb25ca8f34baa57af33260b05efe2874 Linux 4.14.5<br />51a2a68fde2035887c0d74aee1c9569c691dfd61 Linux 4.14.4<br />191314edb326764c4481b09ccf7d00159abe4679 Linux 4.14.3<br />f9f0b03dedc19a6363a305d119efcb48667a3027 Linux 4.14.2<br />780a781dd6f1af9dfac15b8eeba1cb678c9fc380 Linux 4.14.1<br />bebc6082da0a9f5d47a1ea2edc099bf671058bd4 Linux 4.14<br />39dae59d66acd86d1de24294bd2f343fd5e7a625 Linux 4.14-rc8<br />0b07194bb55ed836c2cc7c22e866b87a14681984 Linux 4.14-rc7<br />bb176f67090ca54869fc1262c913aa69d2ede070 Linux 4.14-rc6<br />33d930e59a98fa10a0db9f56c7fa2f21a4aef9b9 Linux 4.14-rc5<br />8a5776a5f49812d29fe4b2d0a2d71675c3facf3f Linux 4.14-rc4<br />9e66317d3c92ddaab330c125dfe9d06eee268aff Linux 4.14-rc3<br />e19b205be43d11bff638cad4487008c48d21c103 Linux 4.14-rc2<br />2bd6bf03f4c1c59381d62c61d03f6cc3fe71f66e Linux 4.14-rc1<br />f9773b22a27a4234f436c9570afd62d905e00a13 Merge tag 'nfs-rdma-for-4.14-1' of git://git.linux-nfs.org/projects/anna/linux-nfs into linux-next<br />2b76da95638010a70435f8455913133acc26e93f Merge branch 'nvme-4.14' of git://git.infradead.org/nvme into fo<br /></pre></td></tr></tbody></table></div><br /><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">I find Linux 4.14 with the commit hash of "bebc6082da0a9f5d47a1ea2edc099bf671058bd4" which is the same hash which I see in the reference kernel when I do a git log.</span></span><br /><span style="font-size: small;"><br /></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">Now I extract all the patches from 4.14 Linux commit hash to the HEAD which is all the Android patches added to the 4.14 LTS version. I do the following:</span></span><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">git diff bebc608 HEAD &gt; 4.14_android.patch<br /></pre></div><br /><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">Next we first check and then apply the 4.14_android.patch to the Reference Linux kernel which we have checked out at tag 4.14 and branched it. I 'cd' to the reference kernel directory and do the following:</span></span><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;">1<br />2</pre></td><td><pre style="line-height: 125%; margin: 0;">git apply --check ../4.14_android.patch<br />git apply ../4.14_android.patch<br /></pre></td></tr></tbody></table></div><br /><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">First I check the patch application to see if there are any errors and then apply without the check.</span></span><br /><span style="font-size: small;"><br /></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">Next I build the kernel. Here I merge the .config files of the board i.e. omap2plus_defconfig, android-base.config and android-recommended.config. I issue the following command:</span></span><br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #996633;">LOADADDR</span><span style="color: #333333;">=</span>0x80008000 <span style="color: #996633;">ARCH</span><span style="color: #333333;">=</span>arm <span style="color: #996633;">CROSS_COMPILE</span><span style="color: #333333;">=</span>arm-linux-gnueabihf- scripts/kconfig/merge_config.sh arch/arm/configs/omap2plus_defconfig kernel/configs/android-base.config kernel/configs/android-recommended.config<br /></pre></div><br /><span style="font-size: small;"><br /></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">A .config file gets generated which I will use to build, flash and verify if the build is working fine using my Debian rootfs. Please note that there might be an issue with the systemd trying to bring up ttyO0 which I am trying to get it resolved. This works fine in the Reference kernel 4.14 and also after merging with just the omapplus2_defconfig but not after the merging of .config files of android and omapplus2.</span></span><br /><span style="font-size: small;"><br /></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">Please note that the terminal and dns might not work. The solution is as follows:</span></span><br /><span style="font-size: small;"><br /></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">For the terminal login to work make sure CONFIG_VT=y and CONFIG_FHANDLE=y.&nbsp;</span></span><br /><span style="font-size: small;"><br /></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">For the DNS to work we need to disable PARANOID_NETWORKING. If you still want to enable PARANOID_NETWORKING then you need to add the following groups with their GIDs:</span></span><br /><span style="font-size: small;"><br /></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">AID_INET: 3003</span></span><br /><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">AID_NET_RAW: 3004</span></span><br /><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">AID_NET_ADMIN: 3005</span></span><br /><span style="font-size: small;"><br /></span><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">My sample addition of users to groups is as follows:</span></span><br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">AID_INET:x:3003:debian,root,avahi,avahi-autoipd,_apt,systemd-timesync,systemd-resolve,systemd-bus-proxy<br />AID_NET_RAW:x:3004:debian,root,avahi,avahi-autoipd,_apt,systemd-timesync,systemd-resolve,systemd-bus-proxy<br />AID_NET_ADMIN:x:3005:debian,root,avahi,avahi-autoipd,_apt,systemd-bus-proxy,systemd-timesync,systemd-resolve<br /></pre></div><br /><span style="font-size: small;"><span style="font-family: &quot;verdana&quot; , sans-serif;">Even though some of the network utilities work I was unable to make apt resolve the addresses. I still need to tinker with the options to make it work. I will update it here when I am able to get it working.</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;verdana&quot; , sans-serif;"><br /></span></span></div>