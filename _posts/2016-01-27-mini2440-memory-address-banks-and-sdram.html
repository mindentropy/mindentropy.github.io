---
layout: post
title: MINI2440 memory address banks and SDRAM setup.
date: '2016-01-27T02:23:00.002+05:30'
author: Gautam Bhat
tags:
- sdram
- K4S561632N
- baremetal OS
modified_time: '2016-02-08T21:06:16.363+05:30'
thumbnail: https://2.bp.blogspot.com/-o8MeWnqPVlk/Vqe1LZiBJWI/AAAAAAAAAAc/Uga_DgsEXMM/s72-c/sram_types.png
blogger_id: tag:blogger.com,1999:blog-2655423030126048565.post-8496234395120565311
blogger_orig_url: https://thesoulofamachine.blogspot.com/2016/01/mini2440-memory-address-banks-and-sdram.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">Initially the loader can be booted up without setting the RAM. This is achieved by the stepping stone controller. This controller fetches first 4KB of data from the NAND flash and places it in the 4KB SRAM called the stepping stone buffer.<br /><br /><br />This SRAM is good enough for the loader to load the MDK OS. To do anything serious we need to setup the SDRAM.<br /><br /><h4 style="text-align: left;"><b><u>My setup:</u></b></h4>In my MINI2440 board I have two Samsung K4S561632N SDRAM chips each of size 32MB totalling 64MB of SDRAM.<br /><br /><br />To proceed further we need to understand the datasheet thoroughly.<br /><br />From the datasheet we have:<br /><blockquote class="tr_bq">&nbsp;&nbsp;&nbsp;<i> The K4S560432N / K4S560832N / K4S561632N is 268,435,456 bits synchronous high data rate Dynamic RAM organized as 4 x 16,777,216 words by 4 bits / 4 x 8,388,608 words by 8bits / 4 x 4,194,304 words by 16bits. </i></blockquote>The SRAM type table is as follows:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-o8MeWnqPVlk/Vqe1LZiBJWI/AAAAAAAAAAc/Uga_DgsEXMM/s1600/sram_types.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="146" src="https://2.bp.blogspot.com/-o8MeWnqPVlk/Vqe1LZiBJWI/AAAAAAAAAAc/Uga_DgsEXMM/s640/sram_types.png" width="640" /></a></div><br /><br /><br />Our memory being the <b>K4S561632N</b> its organization is 4 x 4,194,304 words by 16bits (i.e. 16M x 16). The x16 forms the data bus width i.e. 16 bits or 2 bytes. The "words" in the above sentence means this data bus width i.e. 16 bits. Hence the SDRAM outputs a "word".<br /><br />Also here 268,435,456 bits is 32MB or 256Mb.<br /><br />Notice that all the memories have "4 x " prefix. This is because all these memories&nbsp; have 4 banks and therefore are 4 bank operation chips.<br /><br />The organization in the data sheet is as follows for the 3 different memories:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-jE8IzsfPBb4/Vqe0q0Ld1pI/AAAAAAAAAAU/MvkwKA2bnUM/s1600/sram_orgranization.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="115" src="https://2.bp.blogspot.com/-jE8IzsfPBb4/Vqe0q0Ld1pI/AAAAAAAAAAU/MvkwKA2bnUM/s640/sram_orgranization.png" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"><a href="https://www.blogger.com/blogger.g?blogID=2655423030126048565" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"></a></div><br /><br />In this case our memory organization is the 16Mx16 with Row Address from A0~A12 and Column Address from A0-A8.<br /><br />Hence we can have 2^13 addressable rows and 2^9 addressable columns to make it 4194304 addressable words in each bank. Hence 4 banks x 4194304 addressable words become a total of 16777216 words. Since each word is 16 bits or 2 bytes the chip capacity is 32MB (=16777216 x 2 bytes (16 bits) = 33554432 or 32MB).<br /><br />Similarly we can figure out the numbers for the other 2 memories.<br /><br />For the <b>K4S560832N:</b><br />4 x 8,388,608 words<i> </i>= 33554432 words.<br />Since it is 8 bits per word or 1 byte per word it is 33554432 x 1 = 33554432 or 32MB.<br /><br />For the <b>K4S560432N:</b><br />4 x 16,777,216 = 67108864 words.<br />Since it is 4 bits per word or 1/2 a byte per word it is 67108864 x 1/2 = 33554432 or 32MB.<br /><br /><br />Now we come to how these memory chips are wired to our processor. A diagram of how the chips are wired to the processor is below (ASCII art courtesy of Juergen Borleis of Pengutronix mailing list for helping me understand the bank map configuration):<br /><br /><pre>----------+      /CS to bank#2<br />          |----------------------------------------------------------<br />          |                                            |            |<br />S3C2440   |      /CS to bank#1                         |            |<br />          |------------------------------              |            |<br />          |                  |          |              |            |<br />          |             +--------+  +--------+     +--------+   +--------+<br />          |             | SDRAM1 |  | SDRAM2 |     | SDRAM3 |   | SDRAM4 |<br />          |             |        |  |        |     |        |   |        |<br />          |             +--------+  +--------+     +--------+   +--------+<br />          |            0..15 |          |16..31   0..15|            |16..31<br />          |                  |          |              |            |<br />          |----------------------------------------------------------<br />          |  32 bit databus<br />          |<br />----------+</pre><br /><br />If we go back to schematic we can find that nGCS6 with net name LLnSCS0 is connected to nSCS (SDRAM Chip Select) input of the two 32 MB chips.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-VxdnqaGZEMc/VqfMy2QGyiI/AAAAAAAAAA8/RqvxU6BEZ5s/s1600/sdram_processor_connection.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="https://1.bp.blogspot.com/-VxdnqaGZEMc/VqfMy2QGyiI/AAAAAAAAAA8/RqvxU6BEZ5s/s1600/sdram_processor_connection.png" /></a></div><br /><br /><br /><div class="separator" style="clear: both; text-align: center;">Coming back to the data sheet we see that nGCS6 starts at memory address 0x30000000. Hence our SDRAM memory address starts from 0x30000000. The snapshot of the memory map is below:<a href="http://2.bp.blogspot.com/-qbBUkC3dOVg/Vqe9e5dKHjI/AAAAAAAAAAw/eduFmUVw4lw/s1600/s3c2440_memory_map.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="579" src="https://2.bp.blogspot.com/-qbBUkC3dOVg/Vqe9e5dKHjI/AAAAAAAAAAw/eduFmUVw4lw/s640/s3c2440_memory_map.png" width="640" /></a></div><br />According to the data sheet the nGCS6 forms Bank 6. Hence the two SDRAM chips are connected to Bank6 with both 16 bit bus width forming connected to the 32 bit data bus of the processor. You can verify this in the schematic snapshot below:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-M5pkVtBVO28/VqfNKA0DeVI/AAAAAAAAABE/YHwqHrnXZ50/s1600/sdram_connections.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="324" src="https://3.bp.blogspot.com/-M5pkVtBVO28/VqfNKA0DeVI/AAAAAAAAABE/YHwqHrnXZ50/s640/sdram_connections.png" width="640" /></a></div><a href="https://www.blogger.com/blogger.g?blogID=2655423030126048565" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"></a><a href="https://www.blogger.com/blogger.g?blogID=2655423030126048565" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"></a><a href="https://www.blogger.com/blogger.g?blogID=2655423030126048565" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"></a><br /><br />&nbsp;You can see that the LDATA0 to LDATA15 connections from chip1 and LDATA16 to LDATA31 from chip2 forming the 32 bit data bus width.<br /><br />When an address say 'A' is sent on the address lines for a read from the address then the chip U6 will respond with the data set in address 'A' through LDATA0 - LDATA15. Since the same address lines are fed to chip U7 it too responds with the data set in address 'A' through LDATA16 - LDATA31. When a write is done to address 'A', the first 16 bit data is set in the address 'A' of chip U6 and the send 16 bit data is set in address 'A' of chip U7.<br /><br />Notice that the address pin connections start at ADDR2. For a 32 bit data bus the address is at 4 byte boundaries. <br /><br /><br />Notice that LADDR24 and LADDR25 lines are set as inputs to BA0 and BA1 respectively. BA0 and BA1 forms bank select pins for the chip.<br /><br />Now why is LADDR24 and LADDR25 pins selected?&nbsp; <br /><ol style="text-align: left;"><li>There are 4 banks per chip. Hence the 2 bit combination will allow to select the 4 banks.</li><li>If the bits below LADDR24 are set to 1 it becomes 0xFFFFFF which is 16777215(starting from 0) which is the size of the 4 banks. (4 x4M words). Since the address starts at LADDR2 shift the LADDR24 and LADDR25 by 2 bits to the right. Now we get 0x3FFFFF which is 4194303 (starting from 0) which is the size of the single bank. A 4194304 address switches the bank to 1.&nbsp; Hence as far as I see this is the explanation for the bank switching using the addresses themselves i.e. when the bits of the addresses corresponding to banks change there is a bank switch.</li></ol><h4 style="text-align: left;"><u><b>Register setup:</b></u></h4><div style="text-align: left;">We finally come to source code for the SDRAM setup.&nbsp;</div><div style="text-align: left;">First we need to configure Bus Width and Wait Control register (BWSCON)</div><div style="text-align: left;"></div><div style="text-align: left;">The code is as follows:<br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;">1<br />2<br />3<br />4<br />5<br />6<br />7<br />8</pre></td><td><pre style="line-height: 125%; margin: 0;"><span style="color: #333399; font-weight: bold;">void</span> <span style="color: #0066bb; font-weight: bold;">config_bwscon</span>()<br />{<br /><br /> <span style="color: #888888;">/* Configure BWSCON */</span><br /> writereg32(BWSCON_REG(MEM_BA),<br />   DW7_RESERVED<span style="color: #333333;">|</span>DW6_32b<span style="color: #333333;">|</span>DW5_RESERVED<span style="color: #333333;">|</span>DW4_RESERVED<span style="color: #333333;">|</span><br />   DW3_RESERVED<span style="color: #333333;">|</span>DW2_RESERVED<span style="color: #333333;">|</span>DW1_RESERVED);<br />}<br /></pre></td></tr></tbody></table></div></div><div style="text-align: left;"><br />Here the DW6 parameter is set to DW6_32b i.e. bus width as 32 bit.<br /><br />My SDRAM init is as follows:<br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23<br />24<br />25<br />26</pre></td><td><pre style="line-height: 125%; margin: 0;"><span style="color: #333399; font-weight: bold;">void</span> <span style="color: #0066bb; font-weight: bold;">sdram_init</span>()<br />{<br /><br /> config_bwscon();<br /><br /> <span style="color: #888888;">/* Configure BANKCON6/BANKCON7 */</span><br /> writereg32(BANKCON6_REG(MEM_BA),MT_SYNC_DRAM<span style="color: #333333;">|</span>SCAN_9BIT);<br /><br /> <span style="color: #888888;">/* </span><br /><span style="color: #888888;">  * Set BANKCON7 to ROM/SRAM i.e 00 and not SYNC_DRAM.</span><br /><span style="color: #888888;">  * Rest of the values should not be used as they are reserved</span><br /><span style="color: #888888;">  * Default value is SYNC_DRAM which should not be used.</span><br /><span style="color: #888888;">  */</span><br /> writereg32(BANKCON7_REG(MEM_BA),MT_ROM_SRAM);<br /><br /> <span style="color: #888888;">/* Configure SDRAM Refresh settings */</span><br /> writereg32(REFRESHCTL_REG(MEM_BA),REFEN<span style="color: #333333;">|</span>Tsrc_5<span style="color: #333333;">|</span><span style="color: #0000dd; font-weight: bold;">1269</span>);<br /><br /> <span style="color: #888888;">/* Configure Banksize setting */</span><br /> writereg32(BANKSIZE_REG(MEM_BA),BURST_EN<span style="color: #333333;">|</span>SCKE_EN<span style="color: #333333;">|</span>SCLK_EN<span style="color: #333333;">|</span>BK76MAP_64MB);<br /><br /> <span style="color: #888888;">/* Configure mode set register for BANK6 */</span><br /> writereg32(MRSRB6_REG(MEM_BA),CAS_LATENCY_2CLK);<br /><br /> <span style="color: #008800; font-weight: bold;">return</span>;<br />}<br /></pre></td></tr></tbody></table></div><br />I set the BANKCON6 register to Sync DRAM as it is SDRAM (Synchronous DRAM). For the memory type of SDRAM I set SCAN parameter to SCAN_9BIT as it is A0-A8 or 9 bit.<br /><br />Bank7&nbsp; has to be disabled. Set the BANKCON7 register to MT_ROM_SRAM as it is set default to MT_SYNC_DRAM which should be removed.<br /><br />There is Trcd or RAS to CAS delay to set. In the datasheet the RAS to CAS latency or Trcd(min) is 20ns. In our processor we have setup the HCLK to be 101 Mhz or 9.99ns ~ 10ns. Hence we have to setup or Trcd to have to 2 clock delay which is 00.<br /><br /><b>Refresh control register (REFRESH): </b><br />We set REFEN which is self auto refresh.<br />We set TREFMD to 0 CBR/Auto refresh mode.<br />We set the SDRAM RAS pre-charge time to 2 clocks i.e. value 00 as the data sheet gives a tRP(min) as 20ns or 2 clock cycles.<br />We set the SDRAM semi row cycle time Tsrc to Tsrc_5. The calculation is as follows: <br /><br />Trc = Tsrc + Trp<br />or<br />Tsrc = Trc - Trp<br /><br />From the data sheet we have Trc as 65ns Trp as 20 ns. Hence we get Tsrc as 45ns. Hence we set Tsrc_5 which is 5 clocks or 50ns.<br /><br />I set the refresh counter to 1269 as given in the data sheet example.<br /><br /><b>Banksize register settings (BANKSIZE):</b><br />Here I enable BURST_EN(burst enable), SCKE_EN (SDRAM power down mode enable), SCLK_EN (SCLK being enabled during SDRAM access cycle to reduce power consumption) and BANK76MAP set to 001 or 64MB as the size of the memory is 32MiB + 32MiB = 64MiB.<br /><br /><b>SDRAM Mode register set register (MRSR):</b><br />We simply set the CL parameter or the CAS Latency to 2 clocks. According to the data sheet the CAS latency is 2.<br /><br />&nbsp;<u><b>A note on the memory controller bank select:</b></u><br /><br />The S3C2440 has 8 memory banks. The General Chip select or nGCS should be connected to the different chip selects of the various peripherals connected which use the address space.<br />The banks are activated when the address of a memory is within the address region of the bank. This takes the burden out of doing a chip select manually whenever you want to access the memory region. Hence you can multiplex the address lines to different chips in different banks. When an address is generated the chip in the memory region is automatically selected using the bank chip select signal. I will verify this and provide an oscilloscope trace.<br /><br />For reference from the data sheet:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-3EwN5-t2Rgo/VqzcyF2NyMI/AAAAAAAAACU/dQp4uxtGoMU/s1600/ngcs_info.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="48" src="https://3.bp.blogspot.com/-3EwN5-t2Rgo/VqzcyF2NyMI/AAAAAAAAACU/dQp4uxtGoMU/s640/ngcs_info.png" width="640" /></a></div><br /><br /><br /><br /><b>Conclusion:</b> <br />We do all the SDRAM setup in the loader itself as the MDK OS is loaded onto the SDRAM.<br /><br />References: <a href="http://thread.gmane.org/gmane.comp.embedded.ptxdist.oselas.community/1994/focus=2010">http://thread.gmane.org/gmane.comp.embedded.ptxdist.oselas.community/1994/focus=2010</a><br /><br />Schematics from FriendlyARM.<br />Data sheet snapshots from Samsung S3C2440 data sheet.<br />Memory organization snap shots from Samsung K4S561632N<i> </i>data sheet.<br /><br /><div style="text-align: center;"><b><i>It is better to do the right problem the wrong way than the wrong problem the right way.&nbsp; --Richard Hamming </i></b><b><br /></b></div><br /></div><div style="text-align: left;"></div></div>