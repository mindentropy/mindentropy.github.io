---
layout: post
title: Create a rootfs with Debian debootstrap
date: '2017-12-19T07:39:00.001+05:30'
author: Gautam Bhat
tags: 
modified_time: '2018-01-19T13:01:38.759+05:30'
blogger_id: tag:blogger.com,1999:blog-2655423030126048565.post-3308935849510924721
blogger_orig_url: https://thesoulofamachine.blogspot.com/2017/12/create-rootfs-with-debian-debootstrap.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">I wanted to create a custom rootfs instead of using the RCN debian rootfs image. Following are the steps:<br /><br />We create the first stage of rootfs as follows:<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">sudo debootstrap --arch=armhf --foreign stretch &lt;target_dir&gt;<br /></pre></div><br /><br />This would start downloading the initial bootstrap packages for a successful chroot.<br /><br />Next I do the following to start off the second stage<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;">1<br />2<br />3</pre></td><td><pre style="line-height: 125%; margin: 0;">sudo chroot &lt;target_dir&gt;<br />export LANG=C<br />/debootstrap/debootstrap --second-stage<br /></pre></td></tr></tbody></table></div><br />Next I modify the sources.list file as per my Debian distro from <a href="https://debgen.simplylinux.ch/">https://debgen.simplylinux.ch/</a> <br /><br />I do the following to update and configure packages:<br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;">1<br />2<br />3<br />4</pre></td><td><pre style="line-height: 125%; margin: 0;">apt update<br />apt-get install locales dialog<br />dpkg-reconfigure locales<br />apt install openssh-server ntpdate<br /></pre></td></tr></tbody></table></div><br />Next I run passwd to change my root password.<br /><br />I then do the following to move the files to the target partition from which Linux uses as its root file system<br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;">1<br />2</pre></td><td><pre style="line-height: 125%; margin: 0;">cd target_dir<br />sudo cp -rpv . /mnt/devmnt<br /></pre></td></tr></tbody></table></div><br />Please note that I use the "p" flag to preserve the permissions.<br /><br />This concludes the basic rootfs. There are still things missing like networking which I will experiment and further add to this post.<br /><br />For network connection setup please edit the interfaces file as provided in the Debian network configuration wiki.<br /><br />Sample of my network configuration file:<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;">1<br />2<br />3<br />4<br />5<br />6<br />7</pre></td><td><pre style="line-height: 125%; margin: 0;"># interfaces(5) file used by ifup(8) and ifdown(8)<br /># Include files from /etc/network/interfaces.d:<br />source-directory /etc/network/interfaces.d<br /><br />auto eth0<br />allow-hotplug eth0<br />iface eth0 inet dhcp<br /></pre></td></tr></tbody></table></div><br />I had to install ifupdown2 packages so that there are no errors in the systemd scripts. It uses a ifquery which was not present in the rootfs as the package it was present i.e. ifupdown2 was missing.<br /><br />Also I installed the udhcpd package for DHCP. I am not sure how much it helps but if there is a problem with the interface getting an IP via DHCP this might help.<br /><br />Apart from that I created a normal user with sudo access. Creation is as simple as "adduser &lt;username&gt;" and adding the user to sudo group as "adduser &lt;username&gt; sudo"<br /><br />When chrooting to the directory it might start complaining about pts. We can mount the pts psuedo filesystem as follows:<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;">1</pre></td><td><pre style="line-height: 125%; margin: 0;">mount --bind /dev/pts &lt;rootfs directory&gt;/dev/pts<br /></pre></td></tr></tbody></table></div><br />For further references we can see the excellent debian wiki at <a href="https://wiki.debian.org/chroot">https://wiki.debian.org/chroot</a><br /><br />We will have to install the modules, firmware and headers installation to the rootfs. We can create a temporary directory to verify if all is ok and then copy it to our root filesystem.<br /><br />We do the modules,firmware and headers installation as follows:<br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;">1<br />2<br />3</pre></td><td><pre style="line-height: 125%; margin: 0;">LOADADDR=0x80008000 ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- make -j10 firmware_install INSTALL_FW_PATH=../firmware_path/ <br />LOADADDR=0x80008000 ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- make -j10 modules_install INSTALL_MOD_PATH=../modules_path/<br />LOADADDR=0x80008000 ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- make -j10 headers_install INSTALL_HDR_PATH=../headers_path/<br /></pre></td></tr></tbody></table></div><br />Next we copy the contents of firmware_path to &lt;mountdir&gt;/lib/firmware, modules_path to &lt;mountdir&gt;/lib/modules and headers_path to &lt;mountdir&gt;/usr/</div>